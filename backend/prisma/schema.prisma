generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

model User {
  id            Int         @id @default(autoincrement())
  email         String      @unique
  passwordHash  String      @map("password_hash")
  fullName      String      @map("full_name")
  createdAt     DateTime    @default(now()) @map("created_at")
  documents     Document[]
  payments      Payment[]

  @@map("Users")
}

model Document {
  id          Int           @id @default(autoincrement())
  userId      Int           @map("user_id")
  storagePath String        @map("storage_path")
  status      String        // 'UPLOADED', 'PROCESSING', 'READY_FOR_PREVIEW', 'PAID'
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @default(now()) @updatedAt @map("updated_at")
  
  user        User          @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  tags        DocumentTag[]
  payments    Payment[]

  @@map("Documents")
}

model Tag {
  id       Int           @id @default(autoincrement())
  key      String        @unique
  labelEn  String        @map("label_en")
  labelHe  String        @map("label_he")
  category String
  isSystem Boolean       @default(false) @map("is_system")
  
  documents DocumentTag[]

  @@map("Tags")
}

model DocumentTag {
  documentId Int   @map("document_id")
  tagId      Int   @map("tag_id")
  confidence Float

  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([documentId, tagId])
  @@map("DocumentTags")
}

model Payment {
  id              Int      @id @default(autoincrement())
  userId          Int      @map("user_id")
  documentId      Int      @map("document_id")
  stripeSessionId String   @map("stripe_session_id")
  amount          Decimal  @db.Decimal(10, 2)
  currency        String
  status          String
  createdAt       DateTime @default(now()) @map("created_at")

  user            User     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  document        Document @relation(fields: [documentId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("Payments")
}
